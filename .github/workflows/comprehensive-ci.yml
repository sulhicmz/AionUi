name: Comprehensive CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  schedule:
    # Run security audit weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

# Environment variables
env:
  NODE_VERSION: '20'
  CACHE_VERSION: 'v1'

# Permissions for all jobs
permissions:
  contents: write
  issues: write
  pull-requests: write
  checks: write
  actions: read
  deployments: write

jobs:
  # Code Quality and Testing
  test:
    name: Test & Quality
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Type checking
        run: npx tsc --noEmit --skipLibCheck

      - name: Linting
        run: npm run lint:fix

      - name: Formatting check
        run: npm run format:check

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        if: matrix.node-version == '20.x' && github.event_name != 'pull_request'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          token: ${{ secrets.CODECOV_TOKEN }}

  # Security Scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Run security audit
        run: |
          echo "ğŸ” Running security audit..."
          npm audit --audit-level=moderate --json > audit-results.json || true

          # Extract summary information
          echo "ğŸ“Š Security Audit Summary:"
          npm audit --audit-level=moderate || true

      - name: Check for critical vulnerabilities
        run: |
          # Check for critical or high severity vulnerabilities
          if npm audit --audit-level=high 2>&1 | grep -q "high severity\|critical severity"; then
            echo "âŒ HIGH/CRITICAL vulnerabilities found!"
            exit 1
          else
            echo "âœ… No high/critical vulnerabilities found"
          fi

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-results-${{ github.run_number }}
          path: audit-results.json
          retention-days: 30

      - name: Comment PR with security results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let highVulns = 0;
            let moderateVulns = 0;

            if (fs.existsSync('audit-results.json')) {
              const auditReport = JSON.parse(fs.readFileSync('audit-results.json', 'utf8'));
              highVulns = auditReport.metadata?.vulnerabilities?.high || 0;
              moderateVulns = auditReport.metadata?.vulnerabilities?.moderate || 0;
            }

            const comment = `## ğŸ”’ Security Scan Results

            **Vulnerabilities Found:**
            - ğŸ”´ High: ${highVulns}
            - ğŸŸ¡ Moderate: ${moderateVulns}
            - ğŸ“Š Total: ${highVulns + moderateVulns}

            ${highVulns > 0 ? 'âš ï¸ **Action Required**: High severity vulnerabilities detected. Please address before merging.' : 'âœ… **Ready to merge**: No high severity vulnerabilities found.'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Multi-platform Build
  build:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    needs: [test, security]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/')

    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-arm64'
            os: macos-latest
            arch: arm64
          - platform: 'macos-x64'
            os: macos-latest
            arch: x64
          - platform: 'windows-x64'
            os: windows-latest
            arch: x64
          - platform: 'linux-x64'
            os: ubuntu-latest
            arch: x64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Build application for ${{ matrix.platform }}
        run: |
          if [[ "${{ matrix.platform }}" == macos* ]]; then
            npm run build-mac:${{ matrix.arch }}
          elif [[ "${{ matrix.platform }}" == "windows-x64" ]]; then
            npm run build-win
          elif [[ "${{ matrix.platform }}" == "linux-x64" ]]; then
            npm run build-deb
          fi
        shell: bash

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.platform }}
          path: |
            dist/
            out/
          retention-days: 30

  # Release and Deployment
  release:
    name: Release & Deploy
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/') || (github.ref == 'refs/heads/main' && github.event_name == 'workflow_dispatch')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to staging
        if: github.ref == 'refs/heads/develop'
        run: |
          echo "ğŸš€ Deploying to staging environment..."
          # Add staging deployment logic here
          # Example: Upload to staging server, update staging branch, etc.

      - name: Deploy to production
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ğŸš€ Deploying to production environment..."
          # Add production deployment logic here
          # Example: Upload to production server, update CDN, etc.

      - name: Notify deployment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = context.payload.workflow_run?.conclusion || 'unknown';
            const environment = context.ref.includes('main') ? 'production' : 'staging';

            const message = `## ğŸš€ Deployment Status

            **Environment:** ${environment}
            **Status:** ${status === 'success' ? 'âœ… Success' : 'âŒ Failed'}
            **Commit:** ${context.sha.substring(0, 7)}
            **Branch:** ${context.ref.replace('refs/heads/', '')}

            ${status === 'success' ? 'ğŸ‰ Deployment completed successfully!' : 'ğŸš¨ Deployment failed. Please check the logs.'}
            `;

            github.rest.issues.createComment({
              issue_number: context.repo.run_number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

  # Rollback Job
  rollback:
    name: Emergency Rollback
    runs-on: ubuntu-latest
    if: failure() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    needs: [release]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get previous stable tag
        id: get_tag
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1)
          echo "tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT

      - name: Create rollback release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: 'rollback-${{ steps.get_tag.outputs.tag }}-$(date +%Y%m%d%H%M%S)'
          name: 'Rollback to ${{ steps.get_tag.outputs.tag }}'
          body: |
            ## ğŸš¨ Emergency Rollback

            This is an emergency rollback to the previous stable version: `${{ steps.get_tag.outputs.tag }}`

            **Reason:** Deployment failure detected
            **Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

            Please investigate the deployment failure and fix any issues before redeploying.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify rollback
        uses: actions/github-script@v7
        with:
          script: |
            const message = `## ğŸš¨ Emergency Rollback Initiated

            **Previous Version:** ${{ steps.get_tag.outputs.tag }}
            **Rollback Tag:** rollback-${{ steps.get_tag.outputs.tag }}-$(date +%Y%m%d%H%M%S)
            **Reason:** Deployment failure detected

            Please investigate the deployment failure and fix any issues before redeploying.
            `;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Emergency Rollback',
              body: message,
              labels: ['emergency', 'rollback', 'deployment']
            });

  # Status Report
  status-report:
    name: Pipeline Status
    runs-on: ubuntu-latest
    needs: [test, security, build, release]
    if: always()

    steps:
      - name: Generate status report
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = {
              test: '${{ needs.test.result }}',
              security: '${{ needs.security.result }}',
              build: '${{ needs.build.result }}',
              release: '${{ needs.release.result }}'
            };

            const allSuccess = Object.values(jobs).every(status => status === 'success');
            const hasFailures = Object.values(jobs).some(status => status === 'failure');

            const status = allSuccess ? 'âœ… Success' : hasFailures ? 'âŒ Failed' : 'âš ï¸ Mixed';

            const report = `## ğŸ“Š Pipeline Status Report

            **Overall Status:** ${status}
            **Triggered By:** ${{ github.event_name }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha.substring(0, 7) }}

            ### Job Results:
            - **Test & Quality:** ${{ needs.test.result }}
            - **Security Scan:** ${{ needs.security.result }}
            - **Build:** ${{ needs.build.result }}
            - **Release & Deploy:** ${{ needs.release.result }}

            ${allSuccess ? 'ğŸ‰ All jobs completed successfully!' : 'âŒ Some jobs failed. Please check the logs.'}
            `;

            if (github.event_name === 'pull_request') {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            } else {
              console.log(report);
            }
